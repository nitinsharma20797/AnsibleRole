---
# rabbitmq/tasks/ssl.yml
# -------------------------------
# RabbitMQ SSL setup
# -------------------------------

- name: Install OpenSSL
  package:
    name: openssl
    state: present
  become: yes

- name: Create RabbitMQ SSL directory
  file:
    path: /etc/rabbitmq/ssl
    state: directory
    owner: rabbitmq
    group: rabbitmq
    mode: '0750'
  become: yes

# -------------------------------
# CA CERTIFICATE
# -------------------------------

- name: Generate CA private key
  command: openssl genrsa -out /etc/rabbitmq/ssl/ca.key 2048
  args:
    creates: /etc/rabbitmq/ssl/ca.key
  become: yes

- name: Generate CA certificate
  command: >
    openssl req -x509 -new -nodes
    -key /etc/rabbitmq/ssl/ca.key
    -sha256 -days 3650
    -out /etc/rabbitmq/ssl/ca.pem
    -subj "/C=IN/O=RabbitMQ/OU=CA/CN=RabbitMQ-CA"
  args:
    creates: /etc/rabbitmq/ssl/ca.pem
  become: yes

# -------------------------------
# SERVER CERTIFICATE
# -------------------------------

- name: Generate server private key
  command: openssl genrsa -out /etc/rabbitmq/ssl/server.key 2048
  args:
    creates: /etc/rabbitmq/ssl/server.key
  become: yes

- name: Generate server CSR
  command: >
    openssl req -new
    -key /etc/rabbitmq/ssl/server.key
    -out /etc/rabbitmq/ssl/server.csr
    -subj "/C=IN/O=RabbitMQ/OU=Server/CN={{ inventory_hostname }}"
  args:
    creates: /etc/rabbitmq/ssl/server.csr
  become: yes

- name: Generate server certificate signed by CA
  command: >
    openssl x509 -req
    -in /etc/rabbitmq/ssl/server.csr
    -CA /etc/rabbitmq/ssl/ca.pem
    -CAkey /etc/rabbitmq/ssl/ca.key
    -CAcreateserial
    -out /etc/rabbitmq/ssl/server.pem
    -days 825 -sha256
  args:
    creates: /etc/rabbitmq/ssl/server.pem
  become: yes

# -------------------------------
# PERMISSIONS
# -------------------------------

- name: Set ownership & permissions for SSL files
  file:
    path: /etc/rabbitmq/ssl
    owner: rabbitmq
    group: rabbitmq
    recurse: yes
    mode: '0640'
  become: yes
